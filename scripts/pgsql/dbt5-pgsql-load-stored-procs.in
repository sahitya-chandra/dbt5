#!/bin/sh
@SHELLOPTIONS@
#
# This file is released under the terms of the Artistic License.
# Please see the file LICENSE, included in this package, for details.
#
# Copyright The DBT-5 Authors
#

# All valid procedure names (single source of truth for validation).
PROCS_ALL="broker_volume customer_position data_maintenance market_watch security_detail trade_lookup trade_order trade_result trade_status trade_update"

DBNAMEARG=""
PROCS_ARG=""
SHAREDIR="@CMAKE_INSTALL_PREFIX@/share/dbt5/postgresql"
TYPE="plpgsql"

# Special case to override defaults if in an AppImage environment.
if [ ! "${APPDIR}" = "" ]; then
	SHAREDIR="${APPDIR}/usr/share/dbt5/postgresql"
fi

usage()
{
	cat << EOF
$(basename "${0}") is the Database Test 5 (DBT-5) PostgreSQL user defined functions loader

Usage:
  $(basename "${0}") [OPTIONS]

General options:
  -d DBNAME      PGDATABASE name"
  -i SHAREDIR    PostgreSQL support files location, default ${SHAREDIR}
  -p PORT        PostgreSQL port
  --procs=LIST   Comma-separated procedure names to load (default: all)
  -P LIST        Same as --procs=LIST
  -t TYPE        User defined function type (c|plpgsql), default plpgsql
  -V, --version  Output version information, then exit
  -?, --help     Output this help, then exit

Valid procedure names: broker_volume, customer_position, data_maintenance,
  market_watch, security_detail, trade_lookup, trade_order, trade_result,
  trade_status, trade_update. Use "all" or omit to load all.

@HOMEPAGE@
EOF
}

# Custom argument handling for hopefully most portability.
while [ "${#}" -gt 0 ] ; do
	case "${1}" in
	(-d)
		shift
		DBNAMEARG="-d ${1}"
		;;
	(-d*)
		DBNAMEARG="-d ${1#*-d}"
		;;
	(-i)
		shift
		SHAREDIR="${1}"
		;;
	(-i*)
		SHAREDIR="${1#*-i}"
		;;
	(-p)
		shift
		PORTARG="-p ${1}"
		;;
	(-p*)
		PORTARG="-p ${1#*-p}"
		;;
	(--procs=?*)
		PROCS_ARG="${1#*--procs=}"
		;;
	(-P)
		shift
		PROCS_ARG="${1}"
		;;
	(-P*)
		PROCS_ARG="${1#*-P}"
		;;
	(-t)
		shift
		TYPE="${1}"
		;;
	(-t*)
		TYPE="${1#*-t}"
		;;
	(-V | --version)
		echo "dbt5 (Database Test 5) v@PROJECT_VERSION@"
		exit 0
		;;
	(-\? | --help)
		usage
		exit 0
		;;
	(--* | -*)
		echo "$(basename "${0}"): invalid option -- '${1}'"
		echo "try \"$(basename "${0}") --help\" for more information."
		exit 1
		;;
	(*)
		break
		;;
	esac
	shift
done

PSQL="psql -X ${PORTARG} -e ${DBNAMEARG}"

# Resolve which procedures to load: default all, or user list.
if [ -z "${PROCS_ARG}" ] || [ "${PROCS_ARG}" = "all" ]; then
	PROCS_TO_LOAD="${PROCS_ALL}"
else
	# Convert comma-separated to space-separated and validate each name.
	PROCS_TO_LOAD=""
	for p in $(echo "${PROCS_ARG}" | sed 's/,/ /g'); do
		case " ${PROCS_ALL} " in
			*" ${p} "*)
				PROCS_TO_LOAD="${PROCS_TO_LOAD}${PROCS_TO_LOAD:+ }${p}"
				;;
			*)
				echo "$(basename "${0}"): unknown procedure name: ${p}" 1>&2
				echo "Valid names: ${PROCS_ALL}" 1>&2
				exit 1
				;;
		esac
	done
fi

if [ "${TYPE}" = "c" ]; then
	SHAREDIR="$(pg_config --sharedir)"
	for proc in ${PROCS_TO_LOAD}; do
		eval "${PSQL} -f ${SHAREDIR}/contrib/${proc}.sql" || exit 1
	done
elif [ "${TYPE}" = "plpgsql" ]; then
	for proc in ${PROCS_TO_LOAD}; do
		eval "${PSQL} -f ${SHAREDIR}/${proc}.sql" || exit 1
	done
else
	echo "unknown stored function type: ${TYPE}"
	exit 2
fi
